<?xml version="1.0" encoding="UTF-8"?>

<config>
   <!-- <var-def name="path">/tmp/CitilinkPages/</var-def>-->

    <!--<var-def name="path">allLinks/</var-def>-->
    <var-def name="startURL">http://www.citilink.ru/catalog/computers_and_notebooks/notebooks/</var-def>


    <var-def name="MaxPage">
        <xpath expression="//div[@class='cat_nav top']/div[@class='b']/a[last()]/text()">
            <html-to-xml>
                <http url="${startURL}"/>
            </html-to-xml>
        </xpath>
    </var-def>


        <file action="append" path="${path}/Citilink/list/LatterLinks.xml">
            <![CDATA[ <body> ]]>
        </file>


    <while condition="${MaxPage.toInt() + 1>i.toInt()}" index="i">
        <empty>
            <var-def name="ProductsURL">
                <xpath expression='//table[@class = "item"]'>
                    <html-to-xml>
                        <http url="${startURL}?p=${i.toInt()}"/>
                    </html-to-xml>
                </xpath>
            </var-def>


            <loop item="oneNew" index="j">
                <list>
                    <xpath expression='//td[@class="l"]/*//@href'>
                        <html-to-xml>
                            <var name="ProductsURL"/>
                        </html-to-xml>
                    </xpath>
                </list>
                <body>
                    <empty>

                        <file action="write" path="${path}/Citilink/Pages/${i.toInt()}_${j}.html">
                            <var-def name="oneNewURL">
                                <html-to-xml>
                                    <http url="http://www.citilink.ru${oneNew}?opinion"/>
                                </html-to-xml>
                            </var-def>
                        </file>
                        
                        <var-def name="oneNewDescrPage">
                       		<html-to-xml>
                            	<http url="http://www.citilink.ru${oneNew}"/>
                        	</html-to-xml>
                        </var-def>
                        
                        <file action="write" path="${path}/Citilink/Descriptions/${i.toInt()}_d_${j}.html">    
                        	<var-def name="oneNewDescr">
                        		<xpath expression='//div[@class="item-inner"]/h1[1]/text()'>
                       				<var name="oneNewDescrPage"/>
                    			</xpath>
                        		<xpath expression='//tr/td[position()>1]/../td[position()=1]/p/text() | //tr/td[position()>1]/p/text()'>
                                	<var name="oneNewDescrPage"/>
                            	</xpath>
                         	</var-def>
                         </file>
                        	
							<var-def name="numberOfReviews">
								<xpath expression='//ul[@class="tabs"]/li[@t="t2"]/a/text()'>
                                <html-to-xml>
                                    <http url="http://www.citilink.ru${oneNew}?opinion"/>
                                </html-to-xml>
                                </xpath>
                            </var-def>
							
                        <file action="append" path="${path}/Citilink/list/LatterLinks.xml">
                            <![CDATA[ <page opinionnum="]]><var name="numberOfReviews"/><![CDATA[">]]>
                            <var name="oneNew"/>
                            <![CDATA[ </page>]]>
                        </file>

                    </empty>
                </body>
            </loop>
        </empty>
    </while>

    <file action="append" path="${path}/Citilink/list/LatterLinks.xml">
        <![CDATA[ </body> ]]>
    </file>
</config>
